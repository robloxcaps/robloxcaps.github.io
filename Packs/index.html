<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" id="www-roblox-com">
<head>
<title>PACKS</title>
<link rel="icon" href="../img/FaviIcon.ico" type="image/x-icon"> 
<link rel="stylesheet" href="../style.css">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="author" content="OGMelodii & Jakyro"/>
<meta name="description" content="Contains all packs made by OGMelodii & Jakyro."/>
<meta name="keywords" content="Roblox, Retro, Roblox Pack, Sandbox"/>
<meta name="robots" content="all"/>
</head>
<body>

<form name="aspnetForm" method="post" action="default.aspx" id="aspnetForm">
<div id="Container">
    <!-- HEADER SECTION -->
    <div id="Header">
        <div id="Banner">
            <div id="Options">
                <div id="Settings">
                    <span id="ctl00_lSettings"></span>
                </div>
            </div>
            <!-- Banner Image -->
            <img id="MainBanner" src="../img/2007NoLogoBanner.png" alt="ROBLOX Banner" />
        </div>
        <div id="Navigation">
            <span><a id="ctl00_hlInfo" class="MenuItem" href="../">Info</a></span>
            <span class="Separator">&nbsp;|&nbsp;</span>
            <span><a id="ctl00_hlPacks" class="MenuItem" href="../Packs/">Packs</a></span>
            <span class="Separator">&nbsp;|&nbsp;</span>
            <span><a id="ctl00_hlCredits" class="MenuItem" href="../Credits/">Credits</a></span>
            <span class="Separator">&nbsp;|&nbsp;</span>
            <span><a id="ctl00_Credits" class="MenuItem" href="../Submit/">Submit Packs</a></span>
        </div>
    </div>
    
    <!-- MAIN CONTENT AREA -->
    <div id="Body">
        <div id="MainContent">
            <!-- Loading message -->
            <div id="LoadingMessage">Loading packs...</div>
            
            <!-- Error message (hidden by default) -->
            <div id="ErrorMessage" style="display: none; text-align: center; color: red; padding: 20px;">
                <p>Error loading packs. Please try again later.</p>
                <button onclick="loadPacks()" style="margin-top: 10px; padding: 5px 15px; background: var(--primary-color); color: white; border: none; cursor: pointer;">Retry</button>
            </div>
            
            <!-- Last updated info -->
            <div id="LastUpdated" style="text-align: center; font-size: 12px; color: #666; margin: 10px 0; display: none;">
                Last updated: <span id="UpdateTime"></span>
            </div>
            
            <!-- Pack Grid will be populated by JavaScript -->
            <div class="PackGrid" id="PackGrid" style="display: none;">
                <!-- Pack items will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- FOOTER SECTION -->
    <div id="Footer">
        <hr/>
        <p class="Legalese">
            Â©2026 OGMelodii & Jakyro. All rights reserved.
        </p>
    </div>
</div>
</form>

<script>
// ============================================
// CONFIGURATION 
// ============================================
const GIST_URL = 'https://gist.githubusercontent.com/OGMelodii/5c2f87c5e5020ecd294daba796370a91/raw';
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache
const RETRY_ATTEMPTS = 3;
const RETRY_DELAY = 1000; // 1 second

// ============================================
// MAIN FUNCTIONALITY
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    loadPacks();
});

function loadPacks(retryCount = 0) {
    const loadingMessage = document.getElementById('LoadingMessage');
    const errorMessage = document.getElementById('ErrorMessage');
    const lastUpdated = document.getElementById('LastUpdated');
    
    // Show loading, hide error
    loadingMessage.style.display = 'block';
    errorMessage.style.display = 'none';
    lastUpdated.style.display = 'none';
    
    // Check cache first
    const cachedData = getCachedData();
    if (cachedData && !isCacheExpired(cachedData.timestamp)) {
        console.log('Loading from cache');
        displayPacks(cachedData.packs, cachedData.timestamp);
        return;
    }
    
    // Add cache-busting parameter
    const timestamp = new Date().getTime();
    const url = `${GIST_URL}?t=${timestamp}`;
    
    console.log('Fetching from Gist:', url);
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Validate data structure
            if (!data || !data.packs || !Array.isArray(data.packs)) {
                throw new Error('Invalid data structure: expected data.packs array');
            }
            
            // Cache the data
            cacheData(data.packs);
            
            // Display the packs
            displayPacks(data.packs, new Date().toISOString());
            
            console.log('Successfully loaded', data.packs.length, 'packs');
        })
        .catch(error => {
            console.error('Error loading packs:', error);
            
            // Retry logic
            if (retryCount < RETRY_ATTEMPTS) {
                console.log(`Retrying... Attempt ${retryCount + 1}/${RETRY_ATTEMPTS}`);
                setTimeout(() => loadPacks(retryCount + 1), RETRY_DELAY);
                return;
            }
            
            // Show error message
            loadingMessage.style.display = 'none';
            errorMessage.style.display = 'block';
            
            // Try to use cached data if available
            const fallbackData = getCachedData();
            if (fallbackData) {
                console.log('Using cached data as fallback');
                displayPacks(fallbackData.packs, fallbackData.timestamp, true);
            }
        });
}

function displayPacks(packs, timestamp, isFallback = false) {
    const packGrid = document.getElementById('PackGrid');
    const loadingMessage = document.getElementById('LoadingMessage');
    const lastUpdated = document.getElementById('LastUpdated');
    const updateTime = document.getElementById('UpdateTime');
    
    // Clear loading message
    loadingMessage.style.display = 'none';
    
    // Show pack grid
    packGrid.style.display = 'grid';
    
    // Clear existing content
    packGrid.innerHTML = '';
    
    // Show last updated time
    if (timestamp) {
        const date = new Date(timestamp);
        updateTime.textContent = date.toLocaleString();
        lastUpdated.style.display = 'block';
        
        if (isFallback) {
            updateTime.innerHTML += ' (cached)';
            updateTime.style.color = '#ff9900';
        }
    }
    
    // Create pack items
    packs.forEach((pack, index) => {
        const packItem = createPackItem(pack);
        packGrid.appendChild(packItem);
    });
    
    // Show fallback warning if applicable
    if (isFallback) {
        const warning = document.createElement('div');
        warning.style.cssText = 'text-align: center; color: #ff9900; margin: 10px 0; font-size: 14px;';
        warning.textContent = 'Showing cached data - unable to fetch latest packs';
        packGrid.parentNode.insertBefore(warning, packGrid);
    }
}

function createPackItem(pack) {
    const div = document.createElement('div');
    div.className = 'PackItem';
    
    // Fix icon path - add ../ to paths that start with img/
    let iconPath = pack.icon;
    if (iconPath && iconPath.startsWith('img/')) {
        iconPath = '../' + iconPath;
    }
    
    // Fix download path - add ../ to paths that start with downloads/
    let downloadUrl = pack.downloadUrl;
    if (downloadUrl && downloadUrl.startsWith('downloads/')) {
        downloadUrl = '../' + downloadUrl;
    }
    
    div.innerHTML = `
        <img class="PackIcon" src="${iconPath || 'https://picsum.photos/seed/' + pack.id + '/100/100.jpg'}" 
             alt="${pack.title} Icon" 
             onerror="this.src='https://picsum.photos/seed/' + '${pack.id}' + '/100/100.jpg'"
             loading="lazy">
        <div class="PackTitle">${escapeHtml(pack.title)}</div>
        <div class="PackAuthor">By: ${escapeHtml(pack.author)}</div>
        <div class="PackCategory" style="font-size: 12px; color: #666; margin-bottom: 10px;">Category: ${pack.category || 'Other'}</div>
        ${pack.version ? `<div class="PackVersion" style="font-size: 12px; color: #666; margin-bottom: 10px;">Version: ${pack.version}</div>` : ''}
        <a href="${downloadUrl}" class="PackDownload" target="_blank" download>Download</a>
    `;
    
    return div;
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function cacheData(packs) {
    try {
        const cacheData = {
            packs: packs,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('packsCache', JSON.stringify(cacheData));
    } catch (e) {
        console.warn('Failed to cache data:', e);
    }
}

function getCachedData() {
    try {
        const cached = localStorage.getItem('packsCache');
        return cached ? JSON.parse(cached) : null;
    } catch (e) {
        console.warn('Failed to read cache:', e);
        return null;
    }
}

function isCacheExpired(timestamp) {
    const cachedTime = new Date(timestamp).getTime();
    const now = new Date().getTime();
    return (now - cachedTime) > CACHE_DURATION;
}

// ============================================
// AUTO-REFRESH (OPTIONAL)
// ============================================
// Refresh packs every 5 minutes
setInterval(() => {
    console.log('Auto-refreshing packs...');
    loadPacks();
}, 5 * 60 * 1000);

// ============================================
// SERVICE WORKER FOR OFFLINE SUPPORT (OPTIONAL)
// ============================================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('../sw.js')
            .then(function(registration) {
                console.log('ServiceWorker registration successful');
            })
            .catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
    });
}
</script>
</body>
</html>